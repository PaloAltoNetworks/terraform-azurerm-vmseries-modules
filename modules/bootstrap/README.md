# Palo Alto Networks Bootstrap Module for Azure

A terraform module for deploying a storage account and the dependencies required
to [bootstrap a VM-Series firewalls in Azure](https://docs.paloaltonetworks.com/vm-series/9-1/vm-series-deployment/bootstrap-the-vm-series-firewall/bootstrap-the-vm-series-firewall-in-azure.html#idd51f75b8-e579-44d6-a809-2fafcfe4b3b6).

The module does *not* configure the bootstrap images, licenses, or configurations.

## Usage

For usage examples see:
* [examples/bootstrap](../../examples/bootstrap/README.md)
* [example/vmseries](../../examples/vmseries/README.md).

## Known Limitations

The error message below indicates that one or more of the keys in the `files` input map are not valid - check the file name and the declared file path for possible misspellings or an invalid path reference.
For current versions of Terraform it is not possible to make this message more readable:

```txt
╷
│ Error: Error in function call
│
│   on ../../modules/bootstrap/main.tf line 68, in resource "random_id" "this":
│   68:     md5 = try(var.files_md5[each.key], md5(file(each.key)))
│     ├────────────────
│     │ each.key is "test.txt"
│     │ var.files_md5 is empty map of string
│
│ Call to function "try" failed: no expression succeeded:
│ - Invalid index (at ../../modules/bootstrap/main.tf:68,28-38)
│   The given key does not identify an element in this collection value.
│ - Invalid function argument (at ../../modules/bootstrap/main.tf:68,49-57)
│   Invalid value for "path" parameter: no file exists at test.txt; this function works only with files that are distributed as part of the configuration source code, so if this file will be created by a resource in this configuration you must instead obtain this result from an attribute of that resource.
│
│ At least one expression must produce a successful result.
╵
```

If a file does not exist because it is supposed to be generated by the same Terraform run, add a hash of its contents to
the input `files_md5` as a workaround. For example:

```hcl2
module "bootstrap" {
  # ...
  files     = { (local_file.this.filename) = "config/dynamic-content-test.txt" }
  files_md5 = { (local_file.this.filename) = md5(local_file.this.content) }
}

resource "local_file" "this" {
  filename = "test.txt"
  content  = "hello world"
}
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 0.12.29, < 2.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | ~> 3.7 |
| <a name="requirement_random"></a> [random](#requirement\_random) | ~> 3.1 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | ~> 3.7 |
| <a name="provider_random"></a> [random](#provider\_random) | ~> 3.1 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azurerm_storage_account.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account) | resource |
| [azurerm_storage_share.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_share) | resource |
| [azurerm_storage_share_directory.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_share_directory) | resource |
| [azurerm_storage_share_file.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_share_file) | resource |
| [random_id.this](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/id) | resource |
| [azurerm_storage_account.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/storage_account) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_create_storage_account"></a> [create\_storage\_account](#input\_create\_storage\_account) | If `true`, create a Storage Account. | `bool` | `true` | no |
| <a name="input_files"></a> [files](#input\_files) | Map of all files to copy to bucket. The keys are local paths, the values are remote paths.<br>Always use slash `/` as directory separator (unix-like), not the backslash `\`.<br>Example:<pre>files = {<br>  "dir/my.txt" = "config/init-cfg.txt"<br>}</pre> | `map(string)` | `{}` | no |
| <a name="input_files_md5"></a> [files\_md5](#input\_files\_md5) | Optional map of MD5 hashes of file contents.<br>Normally the map could be all empty, because all the files that exist before the `terraform apply` will have their hashes auto-calculated.<br>This input is necessary only for the selected files which are created/modified within the same Terraform run as this module.<br>The keys of the map should be identical with selected keys of the `files` input, while the values should be MD5 hashes of the contents of that file.<br><br>Example:<pre>files_md5 = {<br>    "dir/my.txt" = "6f7ce3191b50a58cc13e751a8f7ae3fd"<br>}</pre> | `map(string)` | `{}` | no |
| <a name="input_location"></a> [location](#input\_location) | Region to deploy bootstrap resources. Ignored when `create_storage_account` is set to `false`. | `string` | `null` | no |
| <a name="input_min_tls_version"></a> [min\_tls\_version](#input\_min\_tls\_version) | The minimum supported TLS version for the storage account. | `string` | `"TLS1_2"` | no |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | Name of the Resource Group to use. | `string` | n/a | yes |
| <a name="input_storage_account_name"></a> [storage\_account\_name](#input\_storage\_account\_name) | Name of the Storage Account, either a new or an existing one (depending on the value of `create_storage_account`).<br><br>The name you choose must be unique across Azure. The name also must be between 3 and 24 characters in length, and may include only numbers and lowercase letters. | `string` | n/a | yes |
| <a name="input_storage_share_access_tier"></a> [storage\_share\_access\_tier](#input\_storage\_share\_access\_tier) | Access tier for the File Share. | `string` | `"Cool"` | no |
| <a name="input_storage_share_name"></a> [storage\_share\_name](#input\_storage\_share\_name) | Name of a storage File Share to be created that will hold `files` used for bootstrapping.<br>For rules defining a valid name see [Microsoft documentation](https://docs.microsoft.com/en-us/rest/api/storageservices/Naming-and-Referencing-Shares--Directories--Files--and-Metadata#share-names). | `string` | n/a | yes |
| <a name="input_storage_share_quota"></a> [storage\_share\_quota](#input\_storage\_share\_quota) | Maximum size of a File Share. | `number` | `50` | no |
| <a name="input_tags"></a> [tags](#input\_tags) | A map of tags to be associated with the resources created. | `map(string)` | `{}` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_primary_access_key"></a> [primary\_access\_key](#output\_primary\_access\_key) | The primary access key for the Azure Storage Account. |
| <a name="output_storage_account"></a> [storage\_account](#output\_storage\_account) | The Azure Storage Account object used for the Bootstrap. |
| <a name="output_storage_share"></a> [storage\_share](#output\_storage\_share) | The File Share object within Azure Storage used for the Bootstrap. |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
